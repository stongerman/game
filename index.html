<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>å‡¡äººä¿®ä»™ä¼ </title>
<style>
@import url('https://fonts.googleapis.com/css2?family=ZCOOL+QingKe+HuangYou&family=Ma+Shan+Zheng&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg-dark:#0a0a14;--bg-panel:#12121f;--border-pixel:#2a2a4a;--border-highlight:#4a4a7a;
  --text-primary:#d4d4e8;--text-dim:#7a7a9a;--text-gold:#ffd866;--text-cyan:#66eeff;
  --text-red:#ff6666;--text-green:#66ff88;--text-purple:#bb88ff;
  --qi-blue:#4488ff;--hp-red:#ff4444;--exp-gold:#ffaa22;
}
html,body{width:100%;height:100%;background:var(--bg-dark);color:var(--text-primary);
  font-family:'ZCOOL QingKe HuangYou',cursive;overflow:hidden;image-rendering:pixelated;
  -webkit-tap-highlight-color:transparent;-webkit-text-size-adjust:100%}
.pixel-border{border:3px solid var(--border-pixel);box-shadow:inset 0 0 0 1px var(--border-highlight),0 0 0 1px #000}
.pixel-border-gold{border:3px solid #aa8833;box-shadow:inset 0 0 0 1px #ddbb55,0 0 0 1px #000,0 0 20px rgba(255,216,102,0.1)}

/* SCREENS */
#screen-title,#screen-create,#screen-game{position:absolute;top:0;left:0;width:100%;height:100%;display:none}
#screen-create{overflow-y:auto;-webkit-overflow-scrolling:touch}
#screen-title.active,#screen-create.active,#screen-game.active{display:flex}

/* TITLE */
#screen-title{flex-direction:column;align-items:center;justify-content:center;background:var(--bg-dark)}
#title-canvas{position:absolute;top:0;left:0;width:100%;height:100%}
.title-content{position:relative;z-index:2;text-align:center}
.title-content h1{font-family:'Ma Shan Zheng',cursive;font-size:72px;color:var(--text-gold);
  text-shadow:0 0 30px rgba(255,216,102,0.4),0 0 60px rgba(255,216,102,0.2),3px 3px 0 #000;
  margin-bottom:8px;letter-spacing:12px}
.title-content .subtitle{font-size:18px;color:var(--text-dim);margin-bottom:60px;letter-spacing:4px}
.pixel-btn{display:inline-block;padding:14px 48px;background:#1a1a2e;color:var(--text-gold);
  font-family:'ZCOOL QingKe HuangYou',cursive;font-size:20px;border:3px solid #aa8833;
  cursor:pointer;transition:all 0.1s;box-shadow:inset 0 0 0 1px #ddbb55,0 0 0 1px #000;letter-spacing:2px}
.pixel-btn:hover{background:#2a2a3e;box-shadow:inset 0 0 0 1px #ddbb55,0 0 0 1px #000,0 0 20px rgba(255,216,102,0.2)}
.pixel-btn:active{transform:translate(1px,1px)}

/* CREATE */
#screen-create{flex-direction:column;align-items:center;justify-content:center;background:var(--bg-dark)}
.create-panel{width:520px;padding:40px;background:var(--bg-panel);text-align:center}
.create-panel h2{font-family:'Ma Shan Zheng',cursive;font-size:36px;color:var(--text-gold);margin-bottom:30px;letter-spacing:4px}
.form-group{margin-bottom:24px;text-align:left}
.form-group label{display:block;font-size:16px;color:var(--text-cyan);margin-bottom:8px}
.form-group input{width:100%;padding:10px 14px;background:#0a0a14;border:2px solid var(--border-pixel);
  color:var(--text-primary);font-family:'ZCOOL QingKe HuangYou',cursive;font-size:18px;outline:none}
.form-group input:focus{border-color:var(--text-cyan)}
.linggen-options{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.linggen-card{padding:16px;background:#0a0a14;border:2px solid var(--border-pixel);cursor:pointer;transition:all 0.15s;text-align:center}
.linggen-card:hover{border-color:var(--border-highlight)}
.linggen-card.selected{border-color:var(--text-gold);box-shadow:0 0 15px rgba(255,216,102,0.15)}
.linggen-card .lg-name{font-size:20px;margin-bottom:4px}
.linggen-card .lg-desc{font-size:13px;color:var(--text-dim)}
.linggen-card .lg-stars{color:var(--text-gold);font-size:14px;margin-top:4px}
.lg-fire .lg-name{color:#ff6644}.lg-water .lg-name{color:#44aaff}
.lg-wood .lg-name{color:#44ff88}.lg-gold .lg-name{color:#ffcc44}.lg-thunder .lg-name{color:#bb88ff}

/* GAME LAYOUT */
#screen-game{flex-direction:column;background:var(--bg-dark)}
.game-header{display:flex;align-items:center;justify-content:space-between;padding:8px 16px;
  background:#0e0e1a;border-bottom:2px solid var(--border-pixel);min-height:48px;flex-wrap:wrap;gap:2px}
.header-left{display:flex;align-items:center;gap:16px}
.player-name{font-family:'Ma Shan Zheng',cursive;font-size:22px;color:var(--text-gold)}
.realm-badge{font-size:14px;padding:3px 12px;background:rgba(68,136,255,0.15);border:1px solid var(--qi-blue);color:var(--text-cyan);letter-spacing:1px}
.header-right{display:flex;align-items:center;gap:20px;font-size:14px;color:var(--text-dim)}
.header-right span{display:flex;align-items:center;gap:4px}
.age-display{color:var(--text-primary)}.lifespan-display{color:var(--text-red)}.lingshi-display{color:var(--text-gold)}

.game-body{display:flex;flex:1;overflow:hidden}
.scene-area{flex:1;position:relative;display:flex;flex-direction:column}
#scene-canvas{flex:1;width:100%;display:block}
.status-bars{padding:10px 16px;background:#0e0e1a;border-top:2px solid var(--border-pixel);display:flex;gap:16px}
.bar-group{flex:1}
.bar-label{display:flex;justify-content:space-between;font-size:12px;margin-bottom:3px}
.bar-label .bl-name{color:var(--text-dim)}.bar-label .bl-value{color:var(--text-primary)}
.bar-track{height:12px;background:#0a0a14;border:1px solid var(--border-pixel);position:relative;overflow:hidden}
.bar-fill{height:100%;transition:width 0.3s}
.bar-fill.qi{background:linear-gradient(90deg,#2244aa,#4488ff)}
.bar-fill.exp{background:linear-gradient(90deg,#aa6600,#ffaa22)}
.bar-fill.hp{background:linear-gradient(90deg,#aa2222,#ff4444)}

/* RIGHT PANEL */
.right-panel{width:340px;display:flex;flex-direction:column;border-left:2px solid var(--border-pixel);background:var(--bg-panel)}
.panel-tabs{display:flex;background:#0a0a14;border-bottom:2px solid var(--border-pixel)}
.panel-tab{flex:1;padding:8px 0;text-align:center;font-family:'ZCOOL QingKe HuangYou',cursive;
  font-size:13px;color:var(--text-dim);background:none;border:none;cursor:pointer;
  border-bottom:2px solid transparent;transition:all 0.15s}
.panel-tab.active{color:var(--text-cyan);border-bottom-color:var(--text-cyan);background:rgba(68,136,255,0.05)}
.panel-tab:hover{color:var(--text-primary)}

.tab-content{display:none;flex:1;flex-direction:column;overflow:hidden}
.tab-content.active{display:flex}

/* Action tab */
.action-section{padding:12px}
.action-section h3{font-size:15px;color:var(--text-cyan);margin-bottom:10px;letter-spacing:1px}
.action-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.action-btn{padding:10px 8px;background:#0a0a14;border:2px solid var(--border-pixel);color:var(--text-primary);
  font-family:'ZCOOL QingKe HuangYou',cursive;font-size:14px;cursor:pointer;transition:all 0.1s;text-align:center}
.action-btn:hover{border-color:var(--border-highlight);background:#151528}
.action-btn:active{transform:translate(1px,1px)}
.action-btn.highlight{border-color:var(--text-gold);color:var(--text-gold)}
.action-btn:disabled{opacity:0.4;cursor:not-allowed}

/* Log */
.log-section{flex:1;display:flex;flex-direction:column;overflow:hidden;padding:8px 12px}
#game-log{flex:1;overflow-y:auto;font-size:13px;line-height:1.6}
#game-log::-webkit-scrollbar{width:6px}
#game-log::-webkit-scrollbar-track{background:var(--bg-dark)}
#game-log::-webkit-scrollbar-thumb{background:var(--border-pixel)}
.log-entry{padding:3px 0;border-bottom:1px solid rgba(42,42,74,0.3);animation:fadeIn 0.3s}
@keyframes fadeIn{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:translateY(0)}}
.log-time{color:var(--text-dim);font-size:11px}
.log-normal{color:var(--text-primary)}.log-good{color:var(--text-green)}.log-great{color:var(--text-gold)}
.log-danger{color:var(--text-red)}.log-info{color:var(--text-cyan)}.log-purple{color:var(--text-purple)}

/* EQUIP TAB */
.equip-section{padding:12px;overflow-y:auto;flex:1}
.equip-slot{padding:10px;margin-bottom:8px;background:#0a0a14;border:2px solid var(--border-pixel);cursor:pointer;transition:all 0.15s}
.equip-slot:hover{border-color:var(--border-highlight)}
.equip-slot .slot-label{font-size:11px;color:var(--text-dim);margin-bottom:4px}
.equip-slot .slot-name{font-size:15px}
.equip-slot .slot-desc{font-size:11px;color:var(--text-dim);margin-top:2px}
.equip-slot .slot-name.empty{color:var(--text-dim);font-style:italic}
.grade-fan{color:#aaa}.grade-huang{color:#66ff88}.grade-xuan{color:#66eeff}.grade-di{color:#bb88ff}.grade-tian{color:#ffd866}

/* INVENTORY LIST (modal) */
.inv-list{max-height:300px;overflow-y:auto;margin-top:10px}
.inv-item{padding:10px;margin-bottom:6px;background:#0a0a14;border:2px solid var(--border-pixel);cursor:pointer;transition:all 0.15s;text-align:left}
.inv-item:hover{border-color:var(--text-cyan)}
.inv-item .item-name{font-size:14px;margin-bottom:2px}
.inv-item .item-stats{font-size:11px;color:var(--text-dim)}

/* BATTLE OVERLAY */
.battle-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);
  display:none;flex-direction:column;z-index:90}
.battle-overlay.active{display:flex}
.battle-header{text-align:center;padding:12px;font-family:'Ma Shan Zheng',cursive;font-size:24px;color:var(--text-red)}
.battle-stage{flex:1;position:relative}
#battle-canvas{width:100%;height:100%;display:block}
.battle-footer{display:flex;justify-content:space-around;padding:10px 16px;background:#0a0a14;border-top:2px solid var(--border-pixel)}
.battle-bar{flex:1;margin:0 8px}
.battle-bar .bb-label{font-size:12px;display:flex;justify-content:space-between;margin-bottom:2px}
.battle-bar .bb-track{height:10px;background:#0a0a14;border:1px solid var(--border-pixel)}
.battle-bar .bb-fill{height:100%;transition:width 0.2s}
.bb-fill.player-hp{background:linear-gradient(90deg,#22aa44,#44ff66)}
.bb-fill.enemy-hp{background:linear-gradient(90deg,#aa2222,#ff4444)}
.battle-log{text-align:center;padding:6px;font-size:13px;color:var(--text-primary);min-height:24px;background:#08080f}

/* MODAL */
.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.75);
  display:none;align-items:center;justify-content:center;z-index:100}
.modal-overlay.active{display:flex}
.modal-box{width:460px;max-width:92vw;padding:32px;background:var(--bg-panel);text-align:center;max-height:90vh;overflow-y:auto}
.modal-box h2{font-family:'Ma Shan Zheng',cursive;font-size:30px;color:var(--text-gold);margin-bottom:16px}
.modal-box p{font-size:15px;color:var(--text-primary);margin-bottom:12px;line-height:1.7}
.modal-choices{display:flex;flex-direction:column;gap:10px;margin-top:20px}
.modal-choice-btn{padding:12px 20px;background:#0a0a14;border:2px solid var(--border-pixel);color:var(--text-primary);
  font-family:'ZCOOL QingKe HuangYou',cursive;font-size:15px;cursor:pointer;transition:all 0.1s;text-align:left}
.modal-choice-btn:hover{border-color:var(--text-cyan);color:var(--text-cyan)}

/* GAME OVER */
.gameover-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);
  display:none;align-items:center;justify-content:center;z-index:200;flex-direction:column}
.gameover-overlay.active{display:flex}
.gameover-overlay h1{font-family:'Ma Shan Zheng',cursive;font-size:48px;color:var(--text-red);margin-bottom:16px}
.gameover-overlay.ascend h1{color:var(--text-gold);text-shadow:0 0 40px rgba(255,216,102,0.5)}
.gameover-overlay p{font-size:18px;color:var(--text-dim);margin-bottom:32px;text-align:center;padding:0 20px}

@keyframes pulse{
  0%,100%{box-shadow:inset 0 0 0 1px #ddbb55,0 0 0 1px #000}
  50%{box-shadow:inset 0 0 0 1px #ddbb55,0 0 0 1px #000,0 0 20px rgba(255,216,102,0.4)}
}

/* ===== RESPONSIVE ===== */
@media(max-width:768px){
  .title-content h1{font-size:42px;letter-spacing:6px}
  .title-content .subtitle{font-size:14px;margin-bottom:40px}
  .pixel-btn{padding:12px 36px;font-size:17px}
  #screen-create{padding:16px}
  .create-panel{width:100%;max-width:520px;padding:20px}
  .create-panel h2{font-size:28px;margin-bottom:20px}
  .linggen-card{padding:10px 6px}
  .linggen-card .lg-name{font-size:16px}.linggen-card .lg-desc{font-size:11px}.linggen-card .lg-stars{font-size:12px}
  .game-header{padding:6px 10px;min-height:auto}
  .header-left{gap:8px}.player-name{font-size:18px}.realm-badge{font-size:12px;padding:2px 8px}
  .header-right{gap:10px;font-size:12px;width:100%;justify-content:flex-start}
  .game-body{flex-direction:column}
  .scene-area{flex:none;height:35vh;min-height:150px}
  .status-bars{padding:6px 10px;gap:8px}
  .bar-label{font-size:11px}.bar-track{height:10px}
  .right-panel{width:100%;flex:1;border-left:none;border-top:2px solid var(--border-pixel)}
  .panel-tabs{display:flex}
  .action-grid{grid-template-columns:1fr 1fr 1fr;gap:6px}
  .action-btn{padding:10px 4px;font-size:12px}
  .battle-header{font-size:20px;padding:8px}
  .modal-box{padding:20px}
  .modal-box h2{font-size:24px}
  .modal-box p{font-size:14px}
  .modal-choice-btn{font-size:14px;padding:10px 16px}
  .gameover-overlay h1{font-size:36px}
  .gameover-overlay p{font-size:15px}
}
@media(max-width:380px){
  .title-content h1{font-size:34px}
  .linggen-options{grid-template-columns:1fr}
  .action-grid{grid-template-columns:1fr 1fr}
  .header-right{gap:8px;font-size:11px}
}
</style>
</head>
<body>

<!-- TITLE -->
<div id="screen-title" class="active">
  <canvas id="title-canvas"></canvas>
  <div class="title-content">
    <h1>å‡¡äººä¿®ä»™ä¼ </h1>
    <div class="subtitle">ä¸€ä»‹å‡¡äººï¼Œé€†å¤©æ”¹å‘½</div>
    <button class="pixel-btn" onclick="showScreen('create')">è¸å…¥ä»™é€”</button>
    <div style="margin-top:14px"></div>
    <button class="pixel-btn" id="btn-continue" style="display:none" onclick="continueGame()">ç»§ç»­ä¿®ä»™</button>
    <div style="margin-top:10px"></div>
    <button class="pixel-btn" id="btn-clear-save" style="display:none;border-color:#444;color:var(--text-dim)" onclick="clearSaveAndNew()">é‡å¼€å­˜æ¡£</button>
  </div>
</div>

<!-- CREATE -->
<div id="screen-create">
  <div class="create-panel pixel-border-gold">
    <h2>è§’è‰²åˆ›å»º</h2>
    <div class="form-group">
      <label>é“å·</label>
      <input type="text" id="input-name" placeholder="è¾“å…¥ä½ çš„é“å·..." maxlength="8">
    </div>
    <div class="form-group">
      <label>çµæ ¹å±æ€§</label>
      <div class="linggen-options">
        <div class="linggen-card lg-fire" data-type="fire" onclick="selectLinggen(this)"><div class="lg-name">ç«çµæ ¹</div><div class="lg-desc">æ”»å‡»+20%ï¼Œçªç ´æ¦‚ç‡+10%</div><div class="lg-stars">â˜…â˜…â˜…â˜†â˜†</div></div>
        <div class="linggen-card lg-water" data-type="water" onclick="selectLinggen(this)"><div class="lg-name">æ°´çµæ ¹</div><div class="lg-desc">çµåŠ›æ¢å¤å¿«ï¼Œå¯¿å‘½+20å¹´</div><div class="lg-stars">â˜…â˜…â˜…â˜†â˜†</div></div>
        <div class="linggen-card lg-wood" data-type="wood" onclick="selectLinggen(this)"><div class="lg-name">æœ¨çµæ ¹</div><div class="lg-desc">ç”Ÿå‘½+30%ï¼Œç‚¼ä¸¹åŠ æˆ</div><div class="lg-stars">â˜…â˜…â˜…â˜†â˜†</div></div>
        <div class="linggen-card lg-gold" data-type="gold" onclick="selectLinggen(this)"><div class="lg-name">é‡‘çµæ ¹</div><div class="lg-desc">å‰‘é“å¤©èµ‹ï¼Œæˆ˜åŠ›æé«˜</div><div class="lg-stars">â˜…â˜…â˜…â˜…â˜†</div></div>
        <div class="linggen-card lg-thunder" data-type="thunder" onclick="selectLinggen(this)"><div class="lg-name">é›·çµæ ¹</div><div class="lg-desc">å˜å¼‚çµæ ¹ï¼ä¿®ç‚¼æå¿«ä½†çªç ´å±é™©</div><div class="lg-stars">â˜…â˜…â˜…â˜…â˜…</div></div>
      </div>
    </div>
    <button class="pixel-btn" onclick="startGame()" style="margin-top:10px">å¼€å§‹ä¿®ç‚¼</button>
  </div>
</div>

<!-- GAME -->
<div id="screen-game">
  <div class="game-header">
    <div class="header-left">
      <span class="player-name" id="hud-name">æ— å</span>
      <span class="realm-badge" id="hud-realm">ç»ƒæ°”ä¸€å±‚</span>
    </div>
    <div class="header-right">
      <span class="age-display">å¯¿:<b id="hud-age">16</b></span>
      <span class="lifespan-display">é™:<b id="hud-lifespan">100</b></span>
      <span class="lingshi-display">çµçŸ³:<b id="hud-lingshi">0</b></span>
      <span style="color:var(--text-purple)">æˆ˜åŠ›:<b id="hud-power">0</b></span>
    </div>
  </div>
  <div class="game-body">
    <div class="scene-area">
      <canvas id="scene-canvas"></canvas>
      <div class="status-bars">
        <div class="bar-group"><div class="bar-label"><span class="bl-name">çµåŠ›</span><span class="bl-value" id="bar-qi-text">100/100</span></div><div class="bar-track"><div class="bar-fill qi" id="bar-qi" style="width:100%"></div></div></div>
        <div class="bar-group"><div class="bar-label"><span class="bl-name">ä¿®ä¸º</span><span class="bl-value" id="bar-exp-text">0/100</span></div><div class="bar-track"><div class="bar-fill exp" id="bar-exp" style="width:0%"></div></div></div>
        <div class="bar-group"><div class="bar-label"><span class="bl-name">ç”Ÿå‘½</span><span class="bl-value" id="bar-hp-text">100/100</span></div><div class="bar-track"><div class="bar-fill hp" id="bar-hp" style="width:100%"></div></div></div>
      </div>
    </div>
    <div class="right-panel">
      <div class="panel-tabs">
        <button class="panel-tab active" onclick="switchTab('actions')">è¡ŒåŠ¨</button>
        <button class="panel-tab" onclick="switchTab('equip')">è£…å¤‡</button>
        <button class="panel-tab" onclick="switchTab('log')">äº‹ä»¶</button>
      </div>
      <div class="tab-content active" id="tab-actions">
        <div class="action-section">
          <h3>Â· è¡Œ åŠ¨ Â·</h3>
          <div class="action-grid">
            <button class="action-btn" onclick="doAction('meditate')">ğŸ§˜ æ‰“åä¿®ç‚¼</button>
            <button class="action-btn" onclick="doAction('practice')">âš”ï¸ ä¿®ä¹ åŠŸæ³•</button>
            <button class="action-btn" onclick="doAction('explore')">ğŸ”ï¸ å¤–å‡ºæ¢ç´¢</button>
            <button class="action-btn" onclick="doAction('rest')">ğŸ’¤ ä¼‘æ¯æ¢å¤</button>
            <button class="action-btn highlight" id="btn-breakthrough" onclick="doAction('breakthrough')">âš¡ å°è¯•çªç ´</button>
            <button class="action-btn" onclick="doAction('shop')">ğŸª åŠå¸‚äº¤æ˜“</button>
            <button class="action-btn" onclick="doAction('secret')" style="grid-column:span 2">ğŸŒ€ é—¯ç§˜å¢ƒ</button>
          </div>
        </div>
      </div>
      <div class="tab-content" id="tab-equip">
        <div class="equip-section" id="equip-panel"></div>
      </div>
      <div class="tab-content" id="tab-log">
        <div class="log-section"><div id="game-log"></div></div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modal">
  <div class="modal-box pixel-border-gold">
    <h2 id="modal-title">äº‹ä»¶</h2>
    <div id="modal-body"></div>
    <div class="modal-choices" id="modal-choices"></div>
  </div>
</div>

<!-- BATTLE OVERLAY -->
<div class="battle-overlay" id="battle-overlay">
  <div class="battle-header" id="battle-title">âš”ï¸ æˆ˜æ–—</div>
  <div class="battle-stage"><canvas id="battle-canvas"></canvas></div>
  <div class="battle-log" id="battle-log">æˆ˜æ–—å¼€å§‹...</div>
  <div class="battle-footer">
    <div class="battle-bar"><div class="bb-label"><span id="bl-pname">æˆ‘æ–¹</span><span id="bl-php">100/100</span></div><div class="bb-track"><div class="bb-fill player-hp" id="bb-php" style="width:100%"></div></div></div>
    <div class="battle-bar"><div class="bb-label"><span id="bl-ename">æ•Œæ–¹</span><span id="bl-ehp">100/100</span></div><div class="bb-track"><div class="bb-fill enemy-hp" id="bb-ehp" style="width:100%"></div></div></div>
  </div>
</div>

<!-- GAME OVER -->
<div class="gameover-overlay" id="gameover">
  <h1 id="gameover-title">é“é™¨</h1>
  <p id="gameover-desc">å¯¿å…ƒè€—å°½ï¼Œé­‚å½’å¤©åœ°...</p>
  <button class="pixel-btn" onclick="location.reload()">é‡å…¥è½®å›</button>
</div>

<script>
// ========== DATA ==========
const REALMS=[
  {name:'ç»ƒæ°”ä¸€å±‚',expMax:100,lsBonus:0},{name:'ç»ƒæ°”äºŒå±‚',expMax:150,lsBonus:0},
  {name:'ç»ƒæ°”ä¸‰å±‚',expMax:200,lsBonus:0},{name:'ç»ƒæ°”å››å±‚',expMax:280,lsBonus:0},
  {name:'ç»ƒæ°”äº”å±‚',expMax:360,lsBonus:0},{name:'ç»ƒæ°”å…­å±‚',expMax:450,lsBonus:0},
  {name:'ç»ƒæ°”ä¸ƒå±‚',expMax:550,lsBonus:0},{name:'ç»ƒæ°”å…«å±‚',expMax:660,lsBonus:0},
  {name:'ç»ƒæ°”ä¹å±‚',expMax:800,lsBonus:0},
  {name:'ç­‘åŸºåˆæœŸ',expMax:1200,lsBonus:100,major:1},{name:'ç­‘åŸºä¸­æœŸ',expMax:1600,lsBonus:0},{name:'ç­‘åŸºåæœŸ',expMax:2200,lsBonus:0},
  {name:'é‡‘ä¸¹åˆæœŸ',expMax:3500,lsBonus:200,major:1},{name:'é‡‘ä¸¹ä¸­æœŸ',expMax:5000,lsBonus:0},{name:'é‡‘ä¸¹åæœŸ',expMax:7000,lsBonus:0},
  {name:'å…ƒå©´åˆæœŸ',expMax:12000,lsBonus:400,major:1},{name:'å…ƒå©´ä¸­æœŸ',expMax:18000,lsBonus:0},{name:'å…ƒå©´åæœŸ',expMax:25000,lsBonus:0},
  {name:'åŒ–ç¥åˆæœŸ',expMax:40000,lsBonus:500,major:1},{name:'åŒ–ç¥ä¸­æœŸ',expMax:60000,lsBonus:0},{name:'åŒ–ç¥åæœŸ',expMax:85000,lsBonus:0},
  {name:'æ¸¡åŠ«æœŸ',expMax:150000,lsBonus:800,major:1},{name:'å¤§ä¹˜æœŸ',expMax:300000,lsBonus:1000,major:1},
];

const LG={
  fire:{expM:1.0,brk:0.10,ls:0,cbt:1.2,desc:'ç«çµæ ¹'},
  water:{expM:1.1,brk:0.0,ls:20,cbt:1.0,desc:'æ°´çµæ ¹'},
  wood:{expM:1.0,brk:0.0,ls:10,cbt:0.9,desc:'æœ¨çµæ ¹'},
  gold:{expM:0.9,brk:0.05,ls:0,cbt:1.3,desc:'é‡‘çµæ ¹'},
  thunder:{expM:1.3,brk:-0.1,ls:-10,cbt:1.1,desc:'é›·çµæ ¹'},
};

// GONGFA (åŠŸæ³•) database
const GONGFA_DB=[
  {id:'gf_base',name:'åçº³æœ¯',grade:0,atkB:0,defB:0,expB:2,desc:'æœ€åŸºç¡€çš„ä¿®ç‚¼æ³•é—¨'},
  {id:'gf_fire1',name:'ç„šå¤©è¯€',grade:1,atkB:8,defB:0,expB:3,desc:'ç«å±æ€§æ”»å‡»åŠŸæ³•',elem:'fire'},
  {id:'gf_water1',name:'æ²§æ¾œå¿ƒç»',grade:1,atkB:2,defB:6,expB:4,desc:'æ°´å±æ€§é˜²å¾¡åŠŸæ³•',elem:'water'},
  {id:'gf_sword1',name:'å¾¡å‰‘æœ¯',grade:1,atkB:10,defB:0,expB:2,desc:'åŸºç¡€å‰‘ä¿®åŠŸæ³•',elem:'gold'},
  {id:'gf_thunder1',name:'å¼•é›·è¯€',grade:2,atkB:15,defB:0,expB:5,desc:'å¼•åŠ¨å¤©é›·ä¹‹åŠ›',elem:'thunder'},
  {id:'gf_wood1',name:'é•¿æ˜¥åŠŸ',grade:1,atkB:0,defB:5,expB:6,desc:'æœ¨å±æ€§æ¢å¤åŠŸæ³•',elem:'wood'},
  {id:'gf_fire2',name:'ä¹é˜³çœŸç»',grade:2,atkB:20,defB:5,expB:8,desc:'è‡³é˜³è‡³åˆšçš„ä¸Šç­‰åŠŸæ³•',elem:'fire'},
  {id:'gf_sword2',name:'ä¸‡å‰‘å½’å®—',grade:3,atkB:35,defB:5,expB:10,desc:'å‰‘ä¿®è‡³é«˜æ³•é—¨',elem:'gold'},
  {id:'gf_ice1',name:'ç„å†°ç¥åŠŸ',grade:2,atkB:12,defB:15,expB:7,desc:'æå¯’ä¹‹åŠ›ï¼Œæ”»å®ˆå…¼å¤‡',elem:'water'},
  {id:'gf_body1',name:'é‡‘åˆšä¸åä½“',grade:2,atkB:5,defB:25,expB:4,desc:'ç‚¼ä½“è‡³é«˜åŠŸæ³•'},
  {id:'gf_void1',name:'å¤ªè™šå‰‘æ„',grade:3,atkB:40,defB:10,expB:12,desc:'ä¼ è¯´ä¸­çš„è™šç©ºå‰‘é“',elem:'gold'},
  {id:'gf_heaven',name:'å¤©é“æ— æåŠŸ',grade:4,atkB:50,defB:30,expB:20,desc:'å¤©é˜¶åŠŸæ³•ï¼ä¼ è¯´ä»™äººæ‰€åˆ›'},
];

// FABAO (æ³•å®) database
const FABAO_DB=[
  {id:'fb_sword1',name:'é’é”‹å‰‘',grade:0,atkB:5,defB:0,desc:'ä¸€æŠŠæ™®é€šçš„çµå‰‘'},
  {id:'fb_shield1',name:'ç„é“ç›¾',grade:0,atkB:0,defB:8,desc:'åšå›ºçš„é˜²å¾¡æ³•å®'},
  {id:'fb_ring1',name:'å‚¨ç‰©æˆ’',grade:1,atkB:3,defB:3,desc:'å¢åŠ å°‘é‡å…¨å±æ€§'},
  {id:'fb_sword2',name:'å¯’å†°å‰‘',grade:1,atkB:12,defB:0,desc:'é™„å¸¦å†°éœœä¹‹åŠ›'},
  {id:'fb_armor1',name:'é‡‘èš•ä¸ç”²',grade:1,atkB:0,defB:15,desc:'ä»¥çµèš•ä¸ç¼–ç»‡è€Œæˆ'},
  {id:'fb_bell1',name:'æ··å…ƒé’Ÿ',grade:2,atkB:5,defB:20,desc:'å¤è€çš„é˜²å¾¡è‡³å®'},
  {id:'fb_sword3',name:'ç´«ç”µé’éœœ',grade:2,atkB:25,defB:3,desc:'é›·ç”µä¹‹åŠ›å‡èšçš„åå‰‘'},
  {id:'fb_mirror1',name:'ç…§å¦–é•œ',grade:2,atkB:18,defB:12,desc:'å¯ç ´ä¸€åˆ‡å¦–é‚ª'},
  {id:'fb_pagoda1',name:'ç²ç‘å®å¡”',grade:3,atkB:15,defB:35,desc:'é•‡å‹ä¸‡é‚ªçš„ä½›é—¨è‡³å®'},
  {id:'fb_sword4',name:'è¯›ä»™å‰‘',grade:3,atkB:45,defB:5,desc:'ä¸Šå¤è¯›ä»™å››å‰‘ä¹‹é¦–'},
  {id:'fb_cauldron',name:'ä¹¾å¤é¼',grade:4,atkB:30,defB:40,desc:'å¤©é˜¶æ³•å®ï¼è•´å«ä¹¾å¤ä¹‹åŠ›'},
];

// ===== SAVE / LOAD =====
const SAVE_KEY='fanren_save_v1';

function buildDbIndex(arr){
  const m={}; arr.forEach(o=>m[o.id]=o); return m;
}
const GONGFA_BY_ID=buildDbIndex(GONGFA_DB||[]);
const FABAO_BY_ID=buildDbIndex(FABAO_DB||[]);

function serializeState(){
  if(!G || !G.name) return null;
  return {
    v:1,
    name:G.name,
    linggen:G.linggen,
    realmIndex:G.realmIndex,
    exp:G.exp,
    qi:G.qi, qiMax:G.qiMax,
    hp:G.hp, hpMax:G.hpMax,
    age:G.age,
    lifespan:G.lifespan,
    lingshi:G.lingshi,
    baseAtk:G.baseAtk,
    baseDef:G.baseDef,
    meditateLevel:G.meditateLevel,
    gongfaId:G.gongfa?G.gongfa.id:null,
    fabaoId:G.fabao?G.fabao.id:null,
    inventory:(G.inventory||[]).map(i=>({type:i.type,id:i.data.id}))
  };
}

function saveGame(){
  try{
    const data=serializeState();
    if(!data) return;
    localStorage.setItem(SAVE_KEY, JSON.stringify(data));
  }catch(e){/* ignore */}
}

function hasSave(){
  try{ return !!localStorage.getItem(SAVE_KEY); }catch(e){ return false; }
}

function loadGame(){
  try{
    const raw=localStorage.getItem(SAVE_KEY);
    if(!raw) return null;
    const s=JSON.parse(raw);
    if(!s || s.v!==1) return null;

    // Rebuild inventory objects from ids
    const inv=(s.inventory||[]).map(it=>{
      if(it.type==='gongfa') return {type:'gongfa', data:GONGFA_BY_ID[it.id]||GONGFA_DB.find(x=>x.id===it.id)};
      if(it.type==='fabao') return {type:'fabao', data:FABAO_BY_ID[it.id]||FABAO_DB.find(x=>x.id===it.id)};
      return null;
    }).filter(Boolean);

    G={
      name:s.name,
      linggen:s.linggen,
      realmIndex:s.realmIndex||0,
      exp:s.exp||0,
      qi:s.qi||100, qiMax:s.qiMax||100,
      hp:s.hp||100, hpMax:s.hpMax||100,
      age:s.age||16,
      lifespan:s.lifespan||100,
      lingshi:s.lingshi||0,
      baseAtk:s.baseAtk||10,
      baseDef:s.baseDef||5,
      meditateLevel:s.meditateLevel||1,
      actionLocked:false,
      gongfa:null,
      fabao:null,
      inventory:inv
    };

    const gfId=s.gongfaId;
    const fbId=s.fabaoId;
    if(gfId){
      const gf=GONGFA_BY_ID[gfId]||GONGFA_DB.find(x=>x.id===gfId);
      if(gf){ addToInventory('gongfa',gf); G.gongfa=gf; }
    }
    if(fbId){
      const fb=FABAO_BY_ID[fbId]||FABAO_DB.find(x=>x.id===fbId);
      if(fb){ addToInventory('fabao',fb); G.fabao=fb; }
    }
    // Ensure at least starter gongfa exists
    if(!G.gongfa){
      addToInventory('gongfa',GONGFA_DB[0]);
      G.gongfa=GONGFA_DB[0];
    }
    return G;
  }catch(e){ return null; }
}

function continueGame(){
  const ok=loadGame();
  if(!ok){ alert('æ²¡æœ‰æ‰¾åˆ°å¯ç»§ç»­çš„å­˜æ¡£ã€‚'); return; }
  showScreen('game');
  updateHUD();
  renderEquipPanel();
  addLog('ä½ ä»å­˜æ¡£ä¸­è‹é†’ï¼Œç»§ç»­ä¿®ä»™ä¹‹è·¯ã€‚','info');
}

function clearSaveAndNew(){
  try{ localStorage.removeItem(SAVE_KEY); }catch(e){}
  showScreen('create');
}




const GRADE_NAMES=['å‡¡','é»„','ç„','åœ°','å¤©'];
const GRADE_CSS=['grade-fan','grade-huang','grade-xuan','grade-di','grade-tian'];
const GRADE_COLOR=['#aaa','#66ff88','#66eeff','#bb88ff','#ffd866'];

// ENEMIES by realm tier
const ENEMIES=[
  [{name:'ç°ç‹¼å¦–',hp:40,atk:8,def:3,exp:15,ls:5},{name:'æ¯’è›‡ç²¾',hp:35,atk:12,def:2,exp:18,ls:6}],
  [{name:'çŸ³ç”²ç†Š',hp:80,atk:18,def:10,exp:35,ls:12},{name:'é£åˆƒé¹°',hp:60,atk:25,def:5,exp:40,ls:15}],
  [{name:'è¡€è›ŸèŸ’',hp:200,atk:40,def:20,exp:80,ls:30},{name:'å…­å°¾ç‹å¦–',hp:150,atk:55,def:15,exp:90,ls:35}],
  [{name:'ç„æ­¦å¦–å°†',hp:500,atk:80,def:50,exp:200,ls:60},{name:'é‡‘ç¿…å¤§é¹',hp:400,atk:110,def:30,exp:220,ls:70}],
  [{name:'ä¹å¹½é­”é¾™',hp:1200,atk:180,def:80,exp:500,ls:150},{name:'å¤©é­”å°Šè€…',hp:1000,atk:220,def:60,exp:550,ls:180}],
];

// SECRET REALMS
const SECRET_REALMS=[
  {name:'è¿·é›¾è°·',minRealm:0,floors:3,desc:'ç»ƒæ°”æœŸç§˜å¢ƒï¼Œæœ‰ä½é˜¶çµè¯'},
  {name:'å¹½å†¥æ´',minRealm:9,floors:4,desc:'ç­‘åŸºæœŸç§˜å¢ƒï¼Œå¯å¾—é»„é˜¶åŠŸæ³•'},
  {name:'è½æ—¥å³°',minRealm:12,floors:5,desc:'é‡‘ä¸¹æœŸç§˜å¢ƒï¼Œç„é˜¶å®ç‰©å‡ºæ²¡'},
  {name:'é¾™æ¸Šç§˜åºœ',minRealm:15,floors:6,desc:'å…ƒå©´æœŸç§˜å¢ƒï¼Œåœ°é˜¶è‡³å®æ‰€åœ¨'},
  {name:'å¤©åŠ«ä¹‹åœ°',minRealm:18,floors:7,desc:'åŒ–ç¥æœŸç§˜å¢ƒï¼Œå¤©é˜¶æœºç¼˜'},
];

// ========== GAME STATE ==========
let G={};
let selectedLinggen=null;

function selectLinggen(el){
  document.querySelectorAll('.linggen-card').forEach(c=>c.classList.remove('selected'));
  el.classList.add('selected');
  selectedLinggen=el.dataset.type;
}

function initGameState(name,linggen){
  const lg=LG[linggen];
  G={name,linggen,realmIndex:0,exp:0,qi:100,qiMax:100,hp:100,hpMax:100,
    age:16,lifespan:100+lg.ls,lingshi:10,baseAtk:10,baseDef:5,
    meditateLevel:1,actionLocked:false,
    gongfa:null,fabao:null, // equipped
    inventory:[], // {type:'gongfa'|'fabao', data:{...}}
  };
  // Give starter gongfa
  addToInventory('gongfa',GONGFA_DB[0]);
  G.gongfa=GONGFA_DB[0];
}

function addToInventory(type,data){
  if(!G.inventory.find(i=>i.data.id===data.id)){
    G.inventory.push({type,data});
  }
}

function getAtk(){
  let a=G.baseAtk + G.realmIndex*5;
  if(G.gongfa)a+=G.gongfa.atkB;
  if(G.fabao)a+=G.fabao.atkB;
  a*=LG[G.linggen].cbt;
  return Math.floor(a);
}
function getDef(){
  let d=G.baseDef + G.realmIndex*3;
  if(G.gongfa)d+=G.gongfa.defB;
  if(G.fabao)d+=G.fabao.defB;
  return Math.floor(d);
}
function getPower(){ return getAtk()+getDef()+G.realmIndex*10; }

// ========== SCREENS ==========
function showScreen(name){
  document.querySelectorAll('#screen-title,#screen-create,#screen-game').forEach(s=>s.classList.remove('active'));
  document.getElementById('screen-'+name).classList.add('active');
  if(name==='game'){initSceneCanvas();startGameLoop();}
}

function startGame(){
  const name=document.getElementById('input-name').value.trim()||'æ— åæ•£ä¿®';
  if(!selectedLinggen){alert('è¯·é€‰æ‹©çµæ ¹å±æ€§ï¼');return}
  initGameState(name,selectedLinggen);
  showScreen('game');
  updateHUD();
  renderEquipPanel();
  addLog('ä½ è¸å…¥ä¿®ä»™ä¹‹è·¯ï¼Œæˆä¸ºä¸€åç»ƒæ°”æœŸä¿®å£«ã€‚','info');
  addLog(`çµæ ¹å±æ€§ï¼š${LG[selectedLinggen].desc}ï¼Œè·å¾—åŠŸæ³•ã€åçº³æœ¯ã€‘`,'purple');
  addLog('é™å¿ƒæ‰“åï¼Œæ„Ÿå—å¤©åœ°çµæ°”...','normal');
  saveGame();
}

// ========== TABS ==========
function switchTab(tab){
  document.querySelectorAll('.panel-tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
  document.querySelector(`.panel-tab[onclick="switchTab('${tab}')"]`).classList.add('active');
  document.getElementById('tab-'+tab).classList.add('active');
  if(tab==='log'){const l=document.getElementById('game-log');l.scrollTop=l.scrollHeight}
  if(tab==='equip')renderEquipPanel();
}

// ========== HUD ==========
function updateHUD(){
  const r=REALMS[G.realmIndex];
  document.getElementById('hud-name').textContent=G.name;
  document.getElementById('hud-realm').textContent=r.name;
  document.getElementById('hud-age').textContent=G.age;
  document.getElementById('hud-lifespan').textContent=G.lifespan;
  document.getElementById('hud-lingshi').textContent=G.lingshi;
  document.getElementById('hud-power').textContent=getPower();
  const qP=Math.min(100,G.qi/G.qiMax*100),eP=Math.min(100,G.exp/r.expMax*100),hP=Math.min(100,G.hp/G.hpMax*100);
  document.getElementById('bar-qi').style.width=qP+'%';
  document.getElementById('bar-qi-text').textContent=`${G.qi}/${G.qiMax}`;
  document.getElementById('bar-exp').style.width=eP+'%';
  document.getElementById('bar-exp-text').textContent=`${G.exp}/${r.expMax}`;
  document.getElementById('bar-hp').style.width=hP+'%';
  document.getElementById('bar-hp-text').textContent=`${G.hp}/${G.hpMax}`;
  const btn=document.getElementById('btn-breakthrough');
  if(G.exp>=r.expMax&&G.realmIndex<REALMS.length-1){btn.classList.add('highlight');btn.style.animation='pulse 1.5s infinite'}
  else{btn.classList.remove('highlight');btn.style.animation=''}
}

function addLog(text,type='normal'){
  const log=document.getElementById('game-log');
  const e=document.createElement('div');e.className='log-entry';
  e.innerHTML=`<span class="log-time">[${G.age}å²]</span> <span class="log-${type}">${text}</span>`;
  log.appendChild(e);log.scrollTop=log.scrollHeight;
  // Keep log manageable
  while(log.children.length>200)log.removeChild(log.firstChild);
}

// ========== EQUIP PANEL ==========
function renderEquipPanel(){
  const p=document.getElementById('equip-panel');
  const gf=G.gongfa, fb=G.fabao;
  p.innerHTML=`
    <div class="equip-slot" onclick="openEquipChoice('gongfa')">
      <div class="slot-label">åŠŸæ³•</div>
      <div class="slot-name ${gf?GRADE_CSS[gf.grade]:'empty'}">${gf?gf.name:'æœªè£…å¤‡'}</div>
      ${gf?`<div class="slot-desc">æ”»+${gf.atkB} é˜²+${gf.defB} ä¿®+${gf.expB} [${GRADE_NAMES[gf.grade]}é˜¶]</div>`:''}
    </div>
    <div class="equip-slot" onclick="openEquipChoice('fabao')">
      <div class="slot-label">æ³•å®</div>
      <div class="slot-name ${fb?GRADE_CSS[fb.grade]:'empty'}">${fb?fb.name:'æœªè£…å¤‡'}</div>
      ${fb?`<div class="slot-desc">æ”»+${fb.atkB} é˜²+${fb.defB} [${GRADE_NAMES[fb.grade]}é˜¶]</div>`:''}
    </div>
    <div style="padding:12px;border-top:2px solid var(--border-pixel)">
      <div style="font-size:13px;color:var(--text-cyan);margin-bottom:8px">Â· èƒŒåŒ… Â·</div>
      ${G.inventory.length===0?'<div style="color:var(--text-dim);font-size:13px">ç©ºç©ºå¦‚ä¹Ÿ</div>':''}
      ${G.inventory.map(i=>`<div style="font-size:12px;padding:4px 0;color:${GRADE_COLOR[i.data.grade]}">
        ${i.type==='gongfa'?'ğŸ“–':'âš”ï¸'} ${i.data.name} [${GRADE_NAMES[i.data.grade]}é˜¶]
      </div>`).join('')}
    </div>
  `;
}

function openEquipChoice(type){
  const items=G.inventory.filter(i=>i.type===type);
  if(items.length===0){addLog('èƒŒåŒ…ä¸­æ²¡æœ‰å¯è£…å¤‡çš„'+(type==='gongfa'?'åŠŸæ³•':'æ³•å®')+'ã€‚','info');return}
  G.actionLocked=true;
  const modal=document.getElementById('modal');modal.classList.add('active');
  document.getElementById('modal-title').textContent=type==='gongfa'?'é€‰æ‹©åŠŸæ³•':'é€‰æ‹©æ³•å®';
  document.getElementById('modal-body').innerHTML='<p style="font-size:13px;color:var(--text-dim)">ç‚¹å‡»è£…å¤‡</p>';
  const choices=items.map(i=>({
    text:`${i.data.name} [${GRADE_NAMES[i.data.grade]}é˜¶] æ”»+${i.data.atkB} é˜²+${i.data.defB}${type==='gongfa'?' ä¿®+'+i.data.expB:''}`,
    action:()=>{
      if(type==='gongfa')G.gongfa=i.data; else G.fabao=i.data;
      addLog(`è£…å¤‡${type==='gongfa'?'åŠŸæ³•':'æ³•å®'}ã€${i.data.name}ã€‘ï¼`,'info');
      closeModal();renderEquipPanel();updateHUD();saveGame();
    }
  }));
  choices.push({text:'å–æ¶ˆ',action:()=>closeModal()});
  showModalChoices(choices);
}

// ========== MODAL ==========
function showModalChoices(choices){
  const c=document.getElementById('modal-choices');c.innerHTML='';
  choices.forEach(ch=>{
    const b=document.createElement('button');b.className='modal-choice-btn';b.textContent=ch.text;
    b.onclick=()=>ch.action();c.appendChild(b);
  });
}
function closeModal(){document.getElementById('modal').classList.remove('active');G.actionLocked=false;updateHUD()}

// ========== ACTIONS ==========
function doAction(type){
  if(G.actionLocked)return;
  switch(type){
    case 'meditate':actionMeditate();break;case 'practice':actionPractice();break;
    case 'explore':actionExplore();break;case 'rest':actionRest();break;
    case 'breakthrough':actionBreakthrough();break;case 'shop':actionShop();break;
    case 'secret':actionSecret();break;
  }
  G.age++;checkDeath();updateHUD();saveGame();
}

function checkDeath(){
  if(G.age>=G.lifespan)showGameOver(false);
  if(G.hp<=0)showGameOver(false,'ä¿®ç‚¼èµ°ç«å…¥é­”ï¼Œèº«æ­»é“æ¶ˆ...');
}

function showGameOver(asc,msg){
  const o=document.getElementById('gameover');o.classList.add('active');
  if(asc){o.classList.add('ascend');document.getElementById('gameover-title').textContent='é£å‡æˆä»™';
    document.getElementById('gameover-desc').textContent=`${G.name}ï¼Œå†ç»${G.age}å¹´è‹¦ä¿®ï¼Œç»ˆæˆå¤§é“ï¼\næœ€ç»ˆå¢ƒç•Œï¼š${REALMS[G.realmIndex].name}\næˆ˜åŠ›ï¼š${getPower()}`;}
  else{document.getElementById('gameover-title').textContent='é“é™¨';
    document.getElementById('gameover-desc').textContent=msg||`${G.name}ï¼Œäº«å¹´${G.age}å²ï¼Œ${REALMS[G.realmIndex].name}ã€‚\nå¯¿å…ƒè€—å°½ï¼Œé­‚å½’å¤©åœ°...`;}
}

// -- Meditate --
function actionMeditate(){
  const lg=LG[G.linggen];
  const gfBonus=G.gongfa?G.gongfa.expB:0;
  const base=Math.floor((5+G.meditateLevel*2+G.realmIndex+gfBonus)*lg.expM);
  const v=Math.floor(Math.random()*4)-1;
  const gained=Math.max(1,base+v);
  G.exp+=gained;G.qi=Math.max(0,G.qi-5);
  if(Math.random()<0.08){const b=Math.floor(gained*1.5);G.exp+=b;addLog(`æ‰“åä¿®ç‚¼ï¼Œè·å¾—${gained}ä¿®ä¸ºã€‚çµå…‰ä¸€é—ªï¼Œé¡¿æ‚Ÿ+${b}ï¼`,'great')}
  else addLog(`é™å¿ƒæ‰“åï¼Œè·å¾—${gained}ä¿®ä¸ºã€‚`,'normal');
  if(Math.random()<0.12)triggerRandomEvent();
}

// -- Practice --
function actionPractice(){
  const lg=LG[G.linggen];
  const base=Math.floor((3+G.realmIndex)*lg.expM);
  const qiCost=10;
  if(G.qi<qiCost){addLog('çµåŠ›ä¸è¶³ï¼Œä¿®ä¹ æ•ˆæœä¸ä½³ã€‚','danger');G.exp+=Math.floor(base*0.3)}
  else{G.qi-=qiCost;G.exp+=base;
    if(Math.random()<0.3)G.baseAtk++;if(Math.random()<0.2)G.baseDef++;
    addLog(`ä¿®ä¹ åŠŸæ³•ï¼Œè·å¾—${base}ä¿®ä¸ºï¼Œæˆ˜åŠ›å¾®å¢ã€‚`,'normal')}
  if(Math.random()<0.1)triggerRandomEvent();
}

// -- Explore (now can find gongfa/fabao!) --
function actionExplore(){
  const r=Math.random();G.qi=Math.max(0,G.qi-8);
  if(r<0.2){
    const ls=Math.floor(Math.random()*15+5+G.realmIndex*3);G.lingshi+=ls;
    addLog(`æ¢ç´¢å‘ç°${ls}å—çµçŸ³ï¼`,'good');
  } else if(r<0.35){
    // Auto battle!
    const tier=Math.min(4,Math.floor(G.realmIndex/5));
    const pool=ENEMIES[tier];
    const enemy={...pool[Math.floor(Math.random()*pool.length)]};
    enemy.hp=Math.floor(enemy.hp*(0.8+Math.random()*0.4));
    startBattle(enemy);return;
  } else if(r<0.45){
    // Find gongfa!
    const maxGrade=Math.min(4,Math.floor(G.realmIndex/5));
    const pool=GONGFA_DB.filter(g=>g.grade<=maxGrade);
    const found=pool[Math.floor(Math.random()*pool.length)];
    addToInventory('gongfa',found);
    addLog(`å‘ç°åŠŸæ³•ã€${found.name}ã€‘(${GRADE_NAMES[found.grade]}é˜¶)ï¼å·²æ”¾å…¥èƒŒåŒ…ã€‚`,'great');
  } else if(r<0.55){
    // Find fabao!
    const maxGrade=Math.min(3,Math.floor(G.realmIndex/6));
    const pool=FABAO_DB.filter(f=>f.grade<=maxGrade);
    const found=pool[Math.floor(Math.random()*pool.length)];
    addToInventory('fabao',found);
    addLog(`è·å¾—æ³•å®ã€${found.name}ã€‘(${GRADE_NAMES[found.grade]}é˜¶)ï¼`,'great');
  } else if(r<0.65){
    G.hp=Math.min(G.hpMax,G.hp+20);G.qi=Math.min(G.qiMax,G.qi+15);
    addLog('å‘ç°çµè¯ï¼Œæ¢å¤çµåŠ›å’Œç”Ÿå‘½ï¼','good');
  } else if(r<0.75){
    const exp=Math.floor(Math.random()*15+5);G.exp+=exp;
    addLog('å¶é‡æ•£ä¿®äº¤æµï¼Œè·å¾—'+exp+'ä¿®ä¸ºã€‚','info');
  } else{addLog('å››å¤„æ¢ç´¢ï¼Œä¸€æ— æ‰€è·ã€‚','normal')}
  if(Math.random()<0.1)triggerRandomEvent();
}

// -- Rest --
function actionRest(){
  const hr=Math.floor(G.hpMax*0.3),qr=Math.floor(G.qiMax*0.4);
  G.hp=Math.min(G.hpMax,G.hp+hr);G.qi=Math.min(G.qiMax,G.qi+qr);
  addLog(`ä¼‘æ¯æ¢å¤${hr}ç”Ÿå‘½ï¼Œ${qr}çµåŠ›ã€‚`,'normal');
}

// -- Breakthrough --
function actionBreakthrough(){
  const r=REALMS[G.realmIndex];
  if(G.exp<r.expMax){addLog(`ä¿®ä¸ºä¸è¶³(${G.exp}/${r.expMax})ï¼Œæ— æ³•çªç ´ã€‚`,'danger');return}
  if(G.realmIndex>=REALMS.length-1){showGameOver(true);return}
  const next=REALMS[G.realmIndex+1];
  if(next.major){showBreakthroughEvent(next)}
  else{
    if(Math.random()<0.85+LG[G.linggen].brk)advanceRealm();
    else{G.exp=Math.floor(G.exp*0.7);addLog('çªç ´å¤±è´¥ï¼ä¿®ä¸ºå€’é€€ã€‚','danger')}
  }
}

function showBreakthroughEvent(next){
  G.actionLocked=true;
  const m=document.getElementById('modal');m.classList.add('active');
  document.getElementById('modal-title').textContent='âš¡ çªç ´ Â· '+next.name;
  const high=G.realmIndex>=12;
  if(high&&Math.random()<0.5){
    document.getElementById('modal-body').innerHTML='<p>å¤©ç©ºéª¤ç„¶æš—æ²‰ï¼Œç´«è‰²é›·äº‘æ±‡èš...</p><p>å¤©åŠ«é™ä¸´ï¼</p>';
    showModalChoices([
      {text:'ä»¥èº«ç¡¬æŠ—å¤©åŠ«',action:()=>handleTrib('tank')},
      {text:'è¿è½¬åŠŸæ³•åŒ–è§£',action:()=>handleTrib('tech')},
      {text:'æœç”¨ä¸¹è¯æŠ¤ä½“ï¼ˆ20çµçŸ³ï¼‰',action:()=>handleTrib('pill')},
    ]);
  }else{
    document.getElementById('modal-body').innerHTML='<p>æ„è¯†æ²‰å…¥è¯†æµ·æ·±å¤„...</p><p>å¿ƒé­”æ˜¾ç°ï¼</p>';
    showModalChoices([
      {text:'ä»¥é“å¿ƒæ–©ä¹‹',action:()=>handleDemon('fight')},
      {text:'ä»¥å¹³å¸¸å¿ƒæ¥çº³',action:()=>handleDemon('accept')},
      {text:'å¼ºè¡Œå‹åˆ¶å°å°',action:()=>handleDemon('suppress')},
    ]);
  }
}

function handleTrib(ch){
  let rate=0.5+LG[G.linggen].brk,dmg=0;
  if(ch==='tank'){rate+=0.1;dmg=Math.floor(G.hpMax*0.4)}
  else if(ch==='tech'){rate+=0.15;dmg=Math.floor(G.hpMax*0.2)}
  else{if(G.lingshi>=20){G.lingshi-=20;rate+=0.25;dmg=Math.floor(G.hpMax*0.1)}else{addLog('çµçŸ³ä¸è¶³ï¼','danger');closeModal();return}}
  G.hp=Math.max(1,G.hp-dmg);
  if(Math.random()<rate){advanceRealm();addLog('å¤©åŠ«æ•£å»ï¼Œçªç ´æˆåŠŸï¼','great')}
  else{G.exp=Math.floor(G.exp*0.5);G.hp=Math.max(1,G.hp-Math.floor(G.hpMax*0.3));addLog('å¤©åŠ«ä¹‹ä¸‹ï¼Œçªç ´å¤±è´¥ï¼','danger')}
  closeModal();
}

function handleDemon(ch){
  let rate=0.55+LG[G.linggen].brk;
  if(ch==='fight')rate+=0.1;else if(ch==='accept')rate+=0.2;else rate+=0.05;
  if(Math.random()<rate){advanceRealm();addLog('å¿ƒé­”åŒ–è§£ï¼Œçªç ´æˆåŠŸï¼','great')}
  else{
    if(ch==='fight'){G.hp=Math.max(1,G.hp-Math.floor(G.hpMax*0.3));G.exp=Math.floor(G.exp*0.4);addLog('å¿ƒé­”åå™¬ï¼','danger')}
    else{G.exp=Math.floor(G.exp*(ch==='suppress'?0.7:0.6));addLog('çªç ´å¤±è´¥ã€‚','danger')}
  }
  closeModal();
}

function advanceRealm(){
  G.realmIndex++;const r=REALMS[G.realmIndex];G.exp=0;
  G.qiMax+=20;G.hpMax+=15;G.qi=G.qiMax;G.hp=G.hpMax;G.baseAtk+=5;G.baseDef+=3;G.meditateLevel++;
  if(r.lsBonus>0){G.lifespan+=r.lsBonus;addLog(`âœ¨ çªç ´è‡³ã€${r.name}ã€‘ï¼å¯¿å…ƒ+${r.lsBonus}ï¼`,'great')}
  else addLog(`âœ¨ çªç ´è‡³ã€${r.name}ã€‘ï¼`,'great');
  saveGame();
  if(G.realmIndex>=REALMS.length-1&&G.exp>=REALMS[G.realmIndex].expMax)setTimeout(()=>showGameOver(true),500);
}

// -- Shop --
function actionShop(){
  G.actionLocked=true;
  const m=document.getElementById('modal');m.classList.add('active');
  document.getElementById('modal-title').textContent='ğŸª åŠå¸‚';
  document.getElementById('modal-body').innerHTML=`<p>ç³ç…æ»¡ç›®çš„ä¿®ä»™åŠå¸‚ã€‚</p><p style="color:var(--text-dim)">çµçŸ³ï¼š${G.lingshi}</p>`;
  const choices=[
    {text:'å›æ°”ä¸¹ (10çµçŸ³)',action:()=>{if(G.lingshi>=10){G.lingshi-=10;G.qi=Math.min(G.qiMax,G.qi+50);addLog('æœç”¨å›æ°”ä¸¹ï¼','good')}else addLog('çµçŸ³ä¸è¶³ï¼','danger');closeModal()}},
    {text:'ç–—ä¼¤ä¸¹ (10çµçŸ³)',action:()=>{if(G.lingshi>=10){G.lingshi-=10;G.hp=Math.min(G.hpMax,G.hp+50);addLog('æœç”¨ç–—ä¼¤ä¸¹ï¼','good')}else addLog('çµçŸ³ä¸è¶³ï¼','danger');closeModal()}},
    {text:'æ‚Ÿé“ä¸¹ (25çµçŸ³)',action:()=>{if(G.lingshi>=25){G.lingshi-=25;const g=30+G.realmIndex*10;G.exp+=g;addLog(`æ‚Ÿé“ä¸¹+${g}ä¿®ä¸ºï¼`,'great')}else addLog('çµçŸ³ä¸è¶³ï¼','danger');closeModal()}},
  ];
  // Sell random gongfa/fabao at shop
  const shopGrade=Math.min(3,Math.floor(G.realmIndex/5));
  const shopGF=GONGFA_DB.filter(g=>g.grade<=shopGrade+1);
  const randGF=shopGF[Math.floor(Math.random()*shopGF.length)];
  const gfCost=20+randGF.grade*30;
  choices.push({text:`${randGF.name}(${GRADE_NAMES[randGF.grade]}é˜¶åŠŸæ³•) ${gfCost}çµçŸ³`,action:()=>{
    if(G.lingshi>=gfCost){G.lingshi-=gfCost;addToInventory('gongfa',randGF);addLog(`è´­å¾—åŠŸæ³•ã€${randGF.name}ã€‘ï¼`,'great')}else addLog('çµçŸ³ä¸è¶³ï¼','danger');closeModal()}});
  const shopFB=FABAO_DB.filter(f=>f.grade<=shopGrade);
  const randFB=shopFB[Math.floor(Math.random()*shopFB.length)];
  const fbCost=15+randFB.grade*25;
  choices.push({text:`${randFB.name}(${GRADE_NAMES[randFB.grade]}é˜¶æ³•å®) ${fbCost}çµçŸ³`,action:()=>{
    if(G.lingshi>=fbCost){G.lingshi-=fbCost;addToInventory('fabao',randFB);addLog(`è´­å¾—æ³•å®ã€${randFB.name}ã€‘ï¼`,'great')}else addLog('çµçŸ³ä¸è¶³ï¼','danger');closeModal()}});
  choices.push({text:'ç¦»å¼€',action:()=>closeModal()});
  showModalChoices(choices);
}

// -- Secret Realm --
function actionSecret(){
  const available=SECRET_REALMS.filter(s=>G.realmIndex>=s.minRealm);
  if(available.length===0){addLog('å½“å‰å¢ƒç•Œæ²¡æœ‰å¯æŒ‘æˆ˜çš„ç§˜å¢ƒã€‚','info');return}
  G.actionLocked=true;
  const m=document.getElementById('modal');m.classList.add('active');
  document.getElementById('modal-title').textContent='ğŸŒ€ ç§˜å¢ƒé€‰æ‹©';
  document.getElementById('modal-body').innerHTML='<p>é€‰æ‹©è¦é—¯å…¥çš„ç§˜å¢ƒï¼š</p>';
  const choices=available.map(s=>({
    text:`${s.name} (${s.floors}å±‚) - ${s.desc}`,
    action:()=>{closeModal();enterSecretRealm(s)}
  }));
  choices.push({text:'è¿”å›',action:()=>closeModal()});
  showModalChoices(choices);
}

function enterSecretRealm(sr){
  addLog(`è¿›å…¥ç§˜å¢ƒã€${sr.name}ã€‘...`,'purple');
  let floor=0;
  const next=()=>{
    floor++;
    if(floor>sr.floors){
      addLog(`ç§˜å¢ƒã€${sr.name}ã€‘æ¢ç´¢å®Œæ¯•ï¼`,'great');
      // Boss reward
      const maxG=Math.min(4,Math.floor(sr.minRealm/5)+1);
      const pool=[...GONGFA_DB.filter(g=>g.grade<=maxG),...FABAO_DB.filter(f=>f.grade<=maxG)];
      const reward=pool[Math.floor(Math.random()*pool.length)];
      const rType=GONGFA_DB.includes(reward)?'gongfa':'fabao';
      addToInventory(rType,reward);
      addLog(`ç§˜å¢ƒå¥–åŠ±ï¼š${rType==='gongfa'?'åŠŸæ³•':'æ³•å®'}ã€${reward.name}ã€‘(${GRADE_NAMES[reward.grade]}é˜¶)ï¼`,'great');
      G.age+=sr.floors;updateHUD();return;
    }
    const r=Math.random();
    if(r<0.5){
      // Battle
      const tier=Math.min(4,Math.floor(sr.minRealm/5));
      const pool=ENEMIES[tier];
      const enemy={...pool[Math.floor(Math.random()*pool.length)]};
      enemy.name=`${sr.name}Â·${enemy.name}`;
      enemy.hp=Math.floor(enemy.hp*(0.9+floor*0.15));
      enemy.atk=Math.floor(enemy.atk*(0.9+floor*0.12));
      addLog(`ç¬¬${floor}å±‚ï¼šé­é‡${enemy.name}ï¼`,'danger');
      startBattle(enemy,()=>next());
    }else if(r<0.7){
      const ls=Math.floor(10+sr.minRealm*2+Math.random()*20);G.lingshi+=ls;
      addLog(`ç¬¬${floor}å±‚ï¼šå‘ç°å®ç®±ï¼Œè·å¾—${ls}çµçŸ³ï¼`,'good');
      next();
    }else if(r<0.85){
      G.hp=Math.min(G.hpMax,G.hp+Math.floor(G.hpMax*0.2));G.qi=Math.min(G.qiMax,G.qi+Math.floor(G.qiMax*0.2));
      addLog(`ç¬¬${floor}å±‚ï¼šå‘ç°æ³‰æ°´ï¼Œæ¢å¤ä½“åŠ›ã€‚`,'good');next();
    }else{
      const exp=Math.floor(20+sr.minRealm*5+Math.random()*30);G.exp+=exp;
      addLog(`ç¬¬${floor}å±‚ï¼šå‚æ‚Ÿå£ç”»ï¼Œ+${exp}ä¿®ä¸ºã€‚`,'info');next();
    }
  };
  next();
}

// ========== BATTLE SYSTEM ==========
let battleState=null;
let battleCanvas,battleCtx,battleAnim;

function startBattle(enemy,onWinCb){
  battleState={
    enemy:{...enemy,maxHp:enemy.hp},
    playerHp:G.hp,playerMaxHp:G.hpMax,
    turn:0,log:'',done:false,won:false,
    effects:[],onWin:onWinCb||null
  };
  const bo=document.getElementById('battle-overlay');bo.classList.add('active');
  document.getElementById('battle-title').textContent=`âš”ï¸ ${enemy.name}`;
  document.getElementById('bl-pname').textContent=G.name;
  document.getElementById('bl-ename').textContent=enemy.name;
  battleCanvas=document.getElementById('battle-canvas');
  battleCtx=battleCanvas.getContext('2d');
  const rect=battleCanvas.parentElement.getBoundingClientRect();
  battleCanvas.width=Math.floor(rect.width);
  battleCanvas.height=Math.floor(rect.height);
  updateBattleHUD();
  // Auto battle with delay
  battleTurn();
}

function updateBattleHUD(){
  const bs=battleState;
  document.getElementById('bl-php').textContent=`${bs.playerHp}/${bs.playerMaxHp}`;
  document.getElementById('bl-ehp').textContent=`${Math.max(0,bs.enemy.hp)}/${bs.enemy.maxHp}`;
  document.getElementById('bb-php').style.width=Math.max(0,bs.playerHp/bs.playerMaxHp*100)+'%';
  document.getElementById('bb-ehp').style.width=Math.max(0,bs.enemy.hp/bs.enemy.maxHp*100)+'%';
  document.getElementById('battle-log').textContent=bs.log;
}

function battleTurn(){
  if(battleState.done)return;
  battleState.turn++;
  const atk=getAtk(),def=getDef();
  const e=battleState.enemy;

  // Player attacks
  const pDmg=Math.max(1,Math.floor(atk*(0.8+Math.random()*0.4)-e.def*0.3));
  const crit=Math.random()<0.15;
  const finalPDmg=crit?pDmg*2:pDmg;
  e.hp-=finalPDmg;
  battleState.log=`ä½ ä½¿å‡º${G.gongfa?G.gongfa.name:'æ”»å‡»'}ï¼Œé€ æˆ${finalPDmg}ä¼¤å®³${crit?'ï¼ˆæš´å‡»ï¼ï¼‰':''}`;
  battleState.effects.push({type:'hit',x:battleCanvas.width*0.7,y:battleCanvas.height*0.4,t:20,txt:'-'+finalPDmg,color:crit?'#ffd866':'#ff6666'});
  saveGame();
  updateBattleHUD();drawBattle();

  if(e.hp<=0){
    setTimeout(()=>endBattle(true),600);return;
  }

  // Enemy attacks after delay
  setTimeout(()=>{
    const eDmg=Math.max(1,Math.floor(e.atk*(0.8+Math.random()*0.4)-def*0.3));
    battleState.playerHp-=eDmg;
    battleState.log=`${e.name}åå‡»ï¼Œé€ æˆ${eDmg}ä¼¤å®³ï¼`;
    battleState.effects.push({type:'hit',x:battleCanvas.width*0.25,y:battleCanvas.height*0.4,t:20,txt:'-'+eDmg,color:'#ff4444'});
    updateBattleHUD();drawBattle();
    if(battleState.playerHp<=0){setTimeout(()=>endBattle(false),600);return}
    setTimeout(()=>battleTurn(),500);
  },500);
}

function endBattle(won){
  battleState.done=true;battleState.won=won;
  const e=battleState.enemy;
  if(won){
    G.hp=battleState.playerHp;
    G.exp+=e.exp;G.lingshi+=e.ls;
    battleState.log=`èƒœåˆ©ï¼+${e.exp}ä¿®ä¸º +${e.ls}çµçŸ³`;
    addLog(`å‡»è´¥${e.name}ï¼+${e.exp}ä¿®ä¸ºï¼Œ+${e.ls}çµçŸ³ã€‚`,'good');
    // Chance to drop fabao
    if(Math.random()<0.15){
      const maxG=Math.min(3,Math.floor(G.realmIndex/5));
      const pool=FABAO_DB.filter(f=>f.grade<=maxG);
      const drop=pool[Math.floor(Math.random()*pool.length)];
      addToInventory('fabao',drop);
      addLog(`${e.name}æ‰è½æ³•å®ã€${drop.name}ã€‘ï¼`,'great');
    }
  }else{
    G.hp=Math.max(1,Math.floor(G.hpMax*0.1));
    battleState.log='æˆ˜è´¥ï¼ä½ é‡ä¼¤é€ƒç¦»...';
    addLog(`ä¸æ•Œ${e.name}ï¼Œé‡ä¼¤è´¥é€€ã€‚`,'danger');
  }
  updateBattleHUD();drawBattle();
  setTimeout(()=>{
    document.getElementById('battle-overlay').classList.remove('active');
    updateHUD();
    if(won&&battleState.onWin)battleState.onWin();
  },1200);
}

function drawBattle(){
  const c=battleCtx,w=battleCanvas.width,h=battleCanvas.height;
  // BG
  const bg=c.createLinearGradient(0,0,0,h);
  bg.addColorStop(0,'#0a0a1e');bg.addColorStop(1,'#141428');
  c.fillStyle=bg;c.fillRect(0,0,w,h);
  // Ground
  c.fillStyle='#1a1a30';c.fillRect(0,h*0.7,w,h*0.3);

  // Player character (left side)
  drawBattleChar(c,w*0.25,h*0.55,false);
  // Enemy (right side)
  drawBattleEnemy(c,w*0.72,h*0.5);

  // Effects
  battleState.effects=battleState.effects.filter(e=>{
    e.t--;
    c.font='bold 18px "ZCOOL QingKe HuangYou"';
    c.fillStyle=e.color;
    c.globalAlpha=Math.min(1,e.t/10);
    c.fillText(e.txt,e.x-15,e.y-20+e.t*0.5);
    c.globalAlpha=1;
    return e.t>0;
  });

  // VS
  c.font='24px "Ma Shan Zheng"';c.fillStyle='rgba(255,100,100,0.5)';
  c.fillText('VS',w*0.47,h*0.45);
}

function drawBattleChar(c,x,y,flip){
  const px=3;
  // Head
  c.fillStyle='#ddccaa';c.fillRect(x-px,y-px*8,px*3,px*3);
  // Hair
  c.fillStyle='#222';c.fillRect(x-px,y-px*9,px*3,px);c.fillRect(x-px*2,y-px*8,px,px*2);
  // Robe
  const rc=G.realmIndex>=12?'#8866aa':G.realmIndex>=9?'#4466aa':'#334488';
  c.fillStyle=rc;c.fillRect(x-px*2,y-px*5,px*5,px*5);
  // Legs
  c.fillStyle='#2a3366';c.fillRect(x-px,y,px*1.5,px*3);c.fillRect(x+px,y,px*1.5,px*3);
  // Sword
  if(G.fabao){c.fillStyle='#aaccff';c.fillRect(x+px*3,y-px*6,px*0.5,px*7)}
  // Qi aura
  const as=10+5*Math.sin(Date.now()*0.005);
  const au=c.createRadialGradient(x,y-px*2,3,x,y-px*2,as);
  au.addColorStop(0,'rgba(68,136,255,0.3)');au.addColorStop(1,'rgba(68,136,255,0)');
  c.fillStyle=au;c.fillRect(x-as,y-px*2-as,as*2,as*2);
}

function drawBattleEnemy(c,x,y){
  const px=3;const e=battleState.enemy;
  // Body (red-tinted monster)
  c.fillStyle='#883333';c.fillRect(x-px*3,y-px*5,px*6,px*6);
  // Head
  c.fillStyle='#aa4444';c.fillRect(x-px*2,y-px*8,px*4,px*3);
  // Eyes
  c.fillStyle='#ffaa00';c.fillRect(x-px,y-px*7,px,px);c.fillRect(x+px,y-px*7,px,px);
  // Legs
  c.fillStyle='#662222';c.fillRect(x-px*2,y+px,px*2,px*3);c.fillRect(x+px,y+px,px*2,px*3);
  // Aura
  const as=12+4*Math.sin(Date.now()*0.004);
  const au=c.createRadialGradient(x,y-px*2,3,x,y-px*2,as);
  au.addColorStop(0,'rgba(255,68,68,0.25)');au.addColorStop(1,'rgba(255,68,68,0)');
  c.fillStyle=au;c.fillRect(x-as,y-px*2-as,as*2,as*2);
  // Name
  c.font='13px "ZCOOL QingKe HuangYou"';c.fillStyle='#ff8888';
  c.fillText(e.name,x-px*4,y-px*10);
}

// ========== RANDOM EVENTS (enhanced) ==========
function triggerRandomEvent(){
  const events=[
    ()=>{const g=Math.floor(Math.random()*20+10);G.exp+=g;addLog(`å‘ç°å‰äººç‰ç®€ï¼Œ+${g}ä¿®ä¸ºï¼`,'great')},
    ()=>{const g=Math.floor(Math.random()*15+5);G.lingshi+=g;addLog(`çµå…½å¼æ¥${g}å—çµçŸ³ã€‚`,'good')},
    ()=>{G.qi=G.qiMax;addLog('å¤©åœ°çµæ°”æ¶Œå…¥ï¼ŒçµåŠ›å®Œå…¨æ¢å¤ï¼','great')},
    ()=>{const d=Math.floor(Math.random()*15+5);G.hp=Math.max(1,G.hp-d);addLog(`æ¯’é›¾ä¾µä½“ï¼Œ-${d}ç”Ÿå‘½ã€‚`,'danger')},
    ()=>{G.meditateLevel++;addLog('ä»™äººæ¢¦ä¸­æŒ‡ç‚¹ï¼Œä¿®ç‚¼æ„Ÿæ‚Ÿæå‡ï¼','purple')},
    ()=>{G.baseAtk+=3;addLog('ç€‘å¸ƒä¸‹ç»ƒå‰‘ï¼Œæ”»å‡»+3ã€‚','good')},
    ()=>{const l=Math.floor(Math.random()*8+3);G.lingshi=Math.max(0,G.lingshi-l);addLog(`æ•£ä¿®åŠ«é“ï¼Œå¤±å»${l}çµçŸ³ï¼`,'danger')},
    ()=>{G.lifespan+=5;addLog('æœé£Ÿçµæœï¼Œå¯¿å…ƒ+5ï¼','great')},
    ()=>{
      const maxG=Math.min(2,Math.floor(G.realmIndex/5));
      const pool=GONGFA_DB.filter(g=>g.grade<=maxG);
      const f=pool[Math.floor(Math.random()*pool.length)];
      addToInventory('gongfa',f);addLog(`æœºç¼˜å·§åˆå¾—åˆ°åŠŸæ³•ã€${f.name}ã€‘ï¼`,'purple');
    },
    ()=>{G.baseDef+=3;addLog('é¡¿æ‚ŸæŠ¤ä½“çœŸæ°”ï¼Œé˜²å¾¡+3ã€‚','good')},
  ];
  events[Math.floor(Math.random()*events.length)]();
}

// ========== SCENE CANVAS ==========
let sceneCanvas,sceneCtx,sceneParticles=[],sceneFrame=0;
function initSceneCanvas(){
  sceneCanvas=document.getElementById('scene-canvas');
  sceneCtx=sceneCanvas.getContext('2d');
  resizeSceneCanvas();initSceneParticles();
}
function resizeSceneCanvas(){
  const ct=sceneCanvas.parentElement,r=ct.getBoundingClientRect();
  const sb=ct.querySelector('.status-bars'),sh=sb?sb.getBoundingClientRect().height:70;
  sceneCanvas.width=Math.floor(r.width);sceneCanvas.height=Math.max(100,Math.floor(r.height-sh));
}
function initSceneParticles(){
  sceneParticles=[];
  for(let i=0;i<40;i++)sceneParticles.push({x:Math.random()*800,y:Math.random()*600,
    size:Math.random()*2+1,speedY:-(Math.random()*0.3+0.05),speedX:(Math.random()-0.5)*0.2,
    alpha:Math.random()*0.5+0.2,color:['#4488ff','#66eeff','#88aaff','#aaccff'][Math.floor(Math.random()*4)]});
}

function drawScene(){
  const w=sceneCanvas.width,h=sceneCanvas.height,c=sceneCtx;sceneFrame++;
  const isNight=(G.age%24)/24>0.5;
  const sg=c.createLinearGradient(0,0,0,h);
  if(isNight){sg.addColorStop(0,'#05050f');sg.addColorStop(0.5,'#0a0a1e');sg.addColorStop(1,'#0e1020')}
  else{sg.addColorStop(0,'#0a0e2a');sg.addColorStop(0.5,'#121840');sg.addColorStop(1,'#1a2050')}
  c.fillStyle=sg;c.fillRect(0,0,w,h);
  if(isNight){for(let i=0;i<30;i++){const sx=(i*97+13)%w,sy=(i*53+7)%(h*0.5);
    c.fillStyle=`rgba(255,255,255,${(Math.sin(sceneFrame*0.02+i)*0.3+0.7)*0.6})`;c.fillRect(Math.round(sx),Math.round(sy),2,2)}
    c.fillStyle='#ddeeff';c.beginPath();c.arc(w*0.8,h*0.15,20,0,Math.PI*2);c.fill();
    c.fillStyle='#05050f';c.beginPath();c.arc(w*0.8+7,h*0.15-3,18,0,Math.PI*2);c.fill()}
  drawMtn(c,w,h,0.5,'#0e1228',0.35);drawMtn(c,w,h,0.55,'#121838',0.42);drawMtn(c,w,h,0.62,'#1a2248',0.55);
  c.fillStyle='#141a30';c.fillRect(0,h*0.75,w,h*0.25);
  c.fillStyle='#1e2840';for(let i=0;i<w;i+=8)for(let j=h*0.75;j<h;j+=8)if((i+j)%16===0)c.fillRect(i,j,4,4);
  const cx=w*0.35,cy=h*0.58;
  c.fillStyle='#080a14';c.beginPath();c.ellipse(cx,cy+20,40,30,0,Math.PI,0);c.fill();
  const ga=0.2+0.1*Math.sin(sceneFrame*0.03);
  const gl=c.createRadialGradient(cx,cy+10,5,cx,cy+10,50);
  gl.addColorStop(0,`rgba(68,136,255,${ga})`);gl.addColorStop(1,'rgba(68,136,255,0)');
  c.fillStyle=gl;c.fillRect(cx-50,cy-40,100,80);
  drawChar(c,cx,cy+5);
  const as=15+5*Math.sin(sceneFrame*0.05);
  const rc=G.realmIndex>=12?'255,216,102':G.realmIndex>=9?'187,136,255':'68,136,255';
  const au=c.createRadialGradient(cx,cy,5,cx,cy,as);au.addColorStop(0,`rgba(${rc},0.3)`);au.addColorStop(1,`rgba(${rc},0)`);
  c.fillStyle=au;c.fillRect(cx-30,cy-25,60,50);
  drawTree(c,w*0.1,h*0.7,1);drawTree(c,w*0.15,h*0.72,0.8);drawTree(c,w*0.7,h*0.68,1.2);drawTree(c,w*0.8,h*0.71,0.9);drawTree(c,w*0.85,h*0.69,1.1);
  sceneParticles.forEach(p=>{p.x+=p.speedX;p.y+=p.speedY;
    if(p.y<-10){p.y=h+10;p.x=Math.random()*w}if(p.x<-10)p.x=w+10;if(p.x>w+10)p.x=-10;
    c.fillStyle=p.color;c.globalAlpha=p.alpha*(Math.sin(sceneFrame*0.04+p.x*0.01)*0.3+0.7);
    c.fillRect(Math.round(p.x),Math.round(p.y),Math.round(p.size),Math.round(p.size))});
  c.globalAlpha=1;
  drawWaterfall(c,w*0.62,h*0.35,h*0.4);
  c.fillStyle='rgba(0,0,0,0.5)';c.fillRect(8,8,100,24);c.strokeStyle='#2a2a4a';c.strokeRect(8,8,100,24);
  c.fillStyle='#7a7a9a';c.font='14px "ZCOOL QingKe HuangYou"';c.fillText('ğŸ“ çµå±±æ´åºœ',16,25);
}

function drawMtn(c,w,h,by,col,ph){c.fillStyle=col;c.beginPath();c.moveTo(0,h);
  for(let i=0;i<=12;i++){const x=i/12*w;const pk=Math.sin(i*0.8+1)*h*ph*0.3+h*(1-ph);
    const y=by*h+(pk-by*h)*(1-Math.abs(i/12-0.5)*1.2);if(i===0)c.lineTo(x,h*by);c.lineTo(x,Math.min(y,h*by))}
  c.lineTo(w,h);c.fill()}
function drawChar(c,x,y){const p=2;c.fillStyle='#ddccaa';c.fillRect(x-p,y-p*8,p*3,p*3);
  c.fillStyle='#222';c.fillRect(x-p,y-p*9,p*3,p);c.fillRect(x-p*2,y-p*8,p,p*2);
  const rc=G.realmIndex>=12?'#8866aa':G.realmIndex>=9?'#4466aa':'#334488';
  c.fillStyle=rc;c.fillRect(x-p*2,y-p*5,p*5,p*4);c.fillStyle='#2a3366';c.fillRect(x-p*2,y-p*1,p*5,p*2);
  c.fillStyle=rc;c.fillRect(x-p*3,y-p*4,p,p*2);c.fillRect(x+p*3,y-p*4,p,p*2);
  c.fillStyle='#ddccaa';c.fillRect(x-p*3,y-p*2,p,p);c.fillRect(x+p*3,y-p*2,p,p)}
function drawTree(c,x,y,s){const p=Math.round(2*s);c.fillStyle='#3a2a1a';c.fillRect(x-p,y-p*4,p*2,p*5);
  c.fillStyle='#1a4a2a';c.fillRect(x-p*3,y-p*8,p*6,p*3);c.fillRect(x-p*2,y-p*10,p*4,p*2);c.fillRect(x-p,y-p*11,p*2,p)}
function drawWaterfall(c,x,sy,ht){c.fillStyle='rgba(100,180,255,0.15)';c.fillRect(x,sy,6,ht);
  for(let i=0;i<ht;i+=6){const o=(sceneFrame*2+i)%12;c.fillStyle=`rgba(150,200,255,${0.2+0.15*Math.sin(sceneFrame*0.1+i*0.1)})`;
    c.fillRect(x+(o%3),sy+i,2,4)}
  for(let i=0;i<3;i++){c.fillStyle='rgba(150,200,255,0.3)';
    c.fillRect(Math.round(x-5+Math.sin(sceneFrame*0.08+i*2)*8),Math.round(sy+ht+Math.sin(sceneFrame*0.1+i)*3),2,2)}}

// ========== GAME LOOP ==========
let gameRunning=false;
function startGameLoop(){gameRunning=true;gameLoop()}
function gameLoop(){if(!gameRunning)return;
  if(document.getElementById('screen-game').classList.contains('active'))drawScene();
  if(battleState&&!battleState.done)drawBattle();
  requestAnimationFrame(gameLoop)}

// ========== TITLE SCREEN ==========
const titleCanvas=document.getElementById('title-canvas');
const titleCtx=titleCanvas.getContext('2d');
let titleParticles=[];
function initTitle(){titleCanvas.width=window.innerWidth;titleCanvas.height=window.innerHeight;titleParticles=[];
  for(let i=0;i<80;i++)titleParticles.push({x:Math.random()*titleCanvas.width,y:Math.random()*titleCanvas.height,
    size:Math.random()*3+1,speedY:-(Math.random()*0.5+0.1),speedX:(Math.random()-0.5)*0.3,
    alpha:Math.random()*0.6+0.2,color:Math.random()>0.5?'#4488ff':'#66eeff'})}
function drawTitleScreen(){titleCtx.clearRect(0,0,titleCanvas.width,titleCanvas.height);
  const w=titleCanvas.width,h=titleCanvas.height;
  titleCtx.fillStyle='#0e0e1a';titleCtx.beginPath();titleCtx.moveTo(0,h);
  titleCtx.lineTo(0,h*0.7);titleCtx.lineTo(w*0.15,h*0.45);titleCtx.lineTo(w*0.25,h*0.55);
  titleCtx.lineTo(w*0.4,h*0.3);titleCtx.lineTo(w*0.5,h*0.5);titleCtx.lineTo(w*0.6,h*0.25);
  titleCtx.lineTo(w*0.75,h*0.5);titleCtx.lineTo(w*0.85,h*0.35);titleCtx.lineTo(w,h*0.55);titleCtx.lineTo(w,h);titleCtx.fill();
  titleParticles.forEach(p=>{p.x+=p.speedX;p.y+=p.speedY;
    if(p.y<-10){p.y=h+10;p.x=Math.random()*w}
    titleCtx.fillStyle=p.color;titleCtx.globalAlpha=p.alpha*(0.6+0.4*Math.sin(Date.now()*0.002+p.x));
    titleCtx.fillRect(Math.round(p.x),Math.round(p.y),Math.round(p.size),Math.round(p.size))});
  titleCtx.globalAlpha=1;
  if(document.getElementById('screen-title').classList.contains('active'))requestAnimationFrame(drawTitleScreen)}
initTitle();drawTitleScreen();
window.addEventListener('resize',()=>{initTitle();if(sceneCanvas)resizeSceneCanvas()});


// ===== BOOT =====
document.addEventListener('DOMContentLoaded', ()=>{
  try{
    const cont=document.getElementById('btn-continue');
    const clr=document.getElementById('btn-clear-save');
    if(cont && hasSave()){
      cont.style.display='inline-block';
      clr.style.display='inline-block';
    }
  }catch(e){}
});
</script>
</body>
</html>
